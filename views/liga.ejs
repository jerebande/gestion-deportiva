<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liga de F√∫tbol</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #121212;
            color: white;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        .table-container {
            background: #1e1e2f;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(255, 77, 166, 0.2);
            margin-bottom: 30px;
        }

        /* ESTILOS ACTUALIZADOS PARA LA TABLA */
        .tabla-futbol {
            width: 100%;
            border-collapse: collapse;
            margin: 20px auto;
            background-color: #1e1e2f;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(255, 77, 166, 0.2);
        }

        .tabla-futbol thead {
            background: linear-gradient(90deg, #00bcd4, #ff4da6);
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .tabla-futbol th,
        .tabla-futbol td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #333;
            vertical-align: middle;
        }

        .tabla-futbol tbody tr:nth-of-type(odd) {
            background-color: #2c2c3e;
        }

        .tabla-futbol tbody tr:hover {
            background-color: #3a3a5a;
            transition: background-color 0.3s ease;
        }

        /* ESTILOS PARA LOS INPUTS - ALINEADOS Y UNIFORMES */
        .stat-input {
            width: 50px;
            padding: 5px;
            border-radius: 6px;
            border: 1px solid #03a9f4;
            background-color: #0a192f;
            color: #fff;
            text-align: center;
            font-weight: bold;
            box-shadow: inset 0 0 5px #00bcd4;
            margin: 0 auto;
            display: block;
        }

        .stat-input:focus {
            outline: none;
            border-color: #ff4da6;
            box-shadow: 0 0 8px #ff4da6;
        }

        /* ESTILOS PARA LOS DATOS EST√ÅTICOS */
        .stat-value {
            display: inline-block;
            min-width: 30px;
            padding: 4px 8px;
            text-align: center;
            color: white;
        }

        .player-name {
            min-width: 150px;
            display: inline-block;
            text-align: left;
        }

        /* POSICI√ìN Y PUNTOS */
        .position {
            font-weight: bold;
        }

        .points {
            font-weight: bold;
            color: white !important;
        }

        /* FORMULARIOS Y BOTONES */
        .form-section {
            margin-bottom: 2rem;
        }
        .bg-light {
            background-color: #2c2c3e !important;
            color: white;
        }
        .border {
            border: 1px solid #333 !important;
        }
        h1, h2, h3, h4 {
            color: white;
        }
        h1 {
            font-weight: 700;
            text-shadow: 0 0 5px #fff;
        }
        h2 {
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background: linear-gradient(90deg, #00bcd4, #ff4da6);
            border: none;
            box-shadow: 0 0 15px #ff4da6;
        }
        .btn-warning {
            background: linear-gradient(90deg, #ff9800, #ff4da6);
            border: none;
            box-shadow: 0 0 15px #ff9800;
            color: white;
        }
        .btn-success {
            background: linear-gradient(90deg, #4caf50, #00bcd4);
            border: none;
            box-shadow: 0 0 15px #4caf50;
        }
        .form-control, .form-select {
            background-color: #0a192f;
            color: white;
            border: 1px solid #03a9f4;
        }
        .form-control:focus, .form-select:focus {
            background-color: #0a192f;
            color: white;
            border-color: #ff4da6;
            box-shadow: 0 0 8px #ff4da6;
        }
        .text-muted {
            color: #aaa !important;
        }

        /* ESTILOS PARA L√çNEAS DE POSICIONES */
        .champion-zone {
            border-left: 5px solid gold; /* L√≠nea dorada para el campe√≥n de la A */
        }
        .ascenso-zone {
            border-left: 5px solid #00aaff; /* L√≠nea azul para el primero de la B que asciende */
        }
        .relegation-zone {
            border-left: 5px solid #d32f2f; /* L√≠nea roja para la zona de descenso */
        }

        /* === INICIO: ESTILOS PARA LA CINEM√ÅTICA === */
        #cinematic-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(18, 18, 18, 0.95);
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #cinematic-overlay.show {
            display: flex;
            opacity: 1;
        }

        .cinematic-card {
            background: #1e1e2f;
            padding: 25px 40px;
            border-radius: 15px;
            text-align: center;
            min-width: 400px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            opacity: 0; /* Oculto por defecto */
            transform: translateY(30px); /* Posici√≥n inicial para la animaci√≥n */
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }

        .cinematic-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .cinematic-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        #champion-card h3 {
             color: gold;
             animation: spotlight-glow 2s infinite ease-in-out;
        }
        
        #promoted-card h3 {
            color: #4caf50;
        }
        #relegated-card h3 {
            color: #d32f2f;
        }

        .cinematic-card .player-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 1.5rem;
            color: #eee;
        }

        @keyframes spotlight-glow {
            0% { text-shadow: 0 0 8px gold, 0 0 12px #ffc107; }
            50% { text-shadow: 0 0 16px gold, 0 0 24px #ffc107; }
            100% { text-shadow: 0 0 8px gold, 0 0 12px #ffc107; }
        }
        /* === FIN: ESTILOS PARA LA CINEM√ÅTICA === */

    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4 text-center">Gesti√≥n de Ligas ‚öΩ</h1>
        <div class="row form-section">
            <div class="col-md-6">
                <div class="p-3 border rounded bg-light">
                    <h4>‚ûï Agregar Participante</h4>
                    <form action="/liga/agregar-jugador" method="POST">
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre del Jugador</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="division" class="form-label">Divisi√≥n</label>
                            <select class="form-select" id="division" name="division">
                                <option value="A">Primera Divisi√≥n (A)</option>
                                <option value="B">Categor√≠a B</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </form>
                </div>
            </div>
            <div class="col-md-6">
                <div class="p-3 border rounded bg-light">
                    <h4>üèÅ Finalizar y Reiniciar Temporada</h4>
                    <p class="small text-muted">Aplica descensos/ascensos y resetea todas las estad√≠sticas para una nueva temporada.</p>
                    <form id="reiniciar-form" action="/liga/relegation" method="POST">
                        <div class="mb-3">
                            <label for="cantidadDescensos" class="form-label">Cantidad de descensos (desde Div. A)</label>
                            <input type="number" class="form-control" id="cantidadDescensos" name="cantidadDescensos" value="2" min="0">
                        </div>
                        <button type="submit" class="btn btn-warning">Aplicar Cambios y Reiniciar</button>
                    </form>
                </div>
            </div>
        </div>
        <form action="/liga/actualizar" method="POST">
            <div class="table-container mb-5">
                <h2 class="mb-3 text-center">üèÜ Primera Divisi√≥n (A)</h2>
                <% if (ligaA.length > 0) { %>
                    <div class="table-responsive">
                        <table class="tabla-futbol" id="ligaA-table">
                            <thead>
                                <tr>
                                    <th>Pos</th> <th>Nombre</th> <th>PJ</th> <th>PG</th> <th>PE</th> <th>PP</th> <th>GF</th> <th>GC</th> <th>DG</th> <th>Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                <%
                                    ligaA.forEach((jugador, index) => {
                                    let rowClass = 'player-row';
                                    if (index === 0) {
                                        rowClass += ' champion-zone';
                                    }
                                %>
                                <tr class="<%= rowClass %>">
                                    <input type="hidden" name="id[]" value="<%= jugador.id %>">
                                    <td><span class="stat-value position"><%= index + 1 %></span></td>
                                    <td><span class="player-name"><%= jugador.nombre %></span></td>
                                    <td>
                                        <input type="hidden" name="pj[]" class="pj-input" value="<%= jugador.partidos_jugados %>">
                                        <span class="stat-value pj-display"><%= jugador.partidos_jugados %></span>
                                    </td>
                                    <td><input type="number" name="pg[]" class="stat-input" value="<%= jugador.partidos_ganados %>"></td>
                                    <td><input type="number" name="pe[]" class="stat-input" value="<%= jugador.partidos_empatados %>"></td>
                                    <td><input type="number" name="pp[]" class="stat-input" value="<%= jugador.partidos_perdidos %>"></td>
                                    <td><input type="number" name="gf[]" class="stat-input" value="<%= jugador.goles_a_favor %>"></td>
                                    <td><input type="number" name="gc[]" class="stat-input" value="<%= jugador.goles_en_contra %>"></td>
                                    <td><span class="stat-value dg"><%= jugador.diferencia_goles %></span></td>
                                    <td><span class="stat-value points"><%= jugador.puntos %></span></td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <p class="text-center">No hay jugadores en esta divisi√≥n.</p>
                <% } %>
            </div>
            <div class="table-container">
                <h2 class="mb-3 text-center">‚¨ÜÔ∏è Categor√≠a B</h2>
                <p class="small text-muted text-center">El campe√≥n de esta divisi√≥n asciende a Primera Divisi√≥n.</p>
                <% if (ligaB.length > 0) { %>
                    <div class="table-responsive">
                        <table class="tabla-futbol" id="ligaB-table">
                            <thead>
                                <tr>
                                    <th>Pos</th> <th>Nombre</th> <th>PJ</th> <th>PG</th> <th>PE</th> <th>PP</th> <th>GF</th> <th>GC</th> <th>DG</th> <th>Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% ligaB.forEach((jugador, index) => { %>
                                <tr class="player-row <%= index === 0 ? 'ascenso-zone' : '' %>">
                                    <input type="hidden" name="id[]" value="<%= jugador.id %>">
                                    <td><span class="stat-value position"><%= index + 1 %></span></td>
                                    <td><span class="player-name"><%= jugador.nombre %></span></td>
                                    <td>
                                        <input type="hidden" name="pj[]" class="pj-input" value="<%= jugador.partidos_jugados %>">
                                        <span class="stat-value pj-display"><%= jugador.partidos_jugados %></span>
                                    </td>
                                    <td><input type="number" name="pg[]" class="stat-input" value="<%= jugador.partidos_ganados %>"></td>
                                    <td><input type="number" name="pe[]" class="stat-input" value="<%= jugador.partidos_empatados %>"></td>
                                    <td><input type="number" name="pp[]" class="stat-input" value="<%= jugador.partidos_perdidos %>"></td>
                                    <td><input type="number" name="gf[]" class="stat-input" value="<%= jugador.goles_a_favor %>"></td>
                                    <td><input type="number" name="gc[]" class="stat-input" value="<%= jugador.goles_en_contra %>"></td>
                                    <td><span class="stat-value dg"><%= jugador.diferencia_goles %></span></td>
                                    <td><span class="stat-value points"><%= jugador.puntos %></span></td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <p class="text-center">No hay jugadores en esta divisi√≥n.</p>
                <% } %>
            </div>

            <div class="text-center mt-4 mb-5">
                <button type="submit" class="btn btn-success btn-lg">üíæ Guardar Cambios en las Tablas</button>
            </div>
        </form>
    </div>

    <div id="cinematic-overlay">
        <div id="champion-card" class="cinematic-card">
            <h3>üèÜ ¬°CAMPE√ìN! üèÜ</h3>
            <ul id="champion-list" class="player-list"></ul>
        </div>
        <div id="promoted-card" class="cinematic-card">
            <h3>‚¨ÜÔ∏è ASCENDIDO ‚¨ÜÔ∏è</h3>
            <ul id="promoted-list" class="player-list"></ul>
        </div>
        <div id="relegated-card" class="cinematic-card">
            <h3>‚¨áÔ∏è DESCENDIDOS ‚¨áÔ∏è</h3>
            <ul id="relegated-list" class="player-list"></ul>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Script para c√°lculos en tiempo real en las tablas
            document.querySelectorAll('.player-row').forEach(row => {
                const inputs = row.querySelectorAll('.stat-input');

                function updateCalculations() {
                    const pg = parseInt(row.querySelector('[name="pg[]"]').value) || 0;
                    const pe = parseInt(row.querySelector('[name="pe[]"]').value) || 0;
                    const pp = parseInt(row.querySelector('[name="pp[]"]').value) || 0;
                    const gf = parseInt(row.querySelector('[name="gf[]"]').value) || 0;
                    const gc = parseInt(row.querySelector('[name="gc[]"]').value) || 0;

                    const pj = pg + pe + pp;
                    row.querySelector('.pj-input').value = pj;
                    row.querySelector('.pj-display').textContent = pj;

                    const points = (pg * 3) + pe;
                    row.querySelector('.points').textContent = points;

                    const goalDifference = gf - gc;
                    row.querySelector('.dg').textContent = goalDifference;
                }

                inputs.forEach(input => {
                    input.addEventListener('input', updateCalculations);
                });
            });

            // Script para resaltar la zona de descenso din√°micamente
            const cantDescensosInput = document.getElementById('cantidadDescensos');
            const ligaATableRows = document.querySelectorAll('#ligaA-table tbody .player-row');

            const savedDescensos = localStorage.getItem('cantidadDescensos');
            if (savedDescensos !== null) {
                cantDescensosInput.value = savedDescensos;
            }

            function updateRelegationZone() {
                const cantidadDescensos = parseInt(cantDescensosInput.value) || 0;
                const totalPlayers = ligaATableRows.length;

                ligaATableRows.forEach(row => row.classList.remove('relegation-zone'));

                for (let i = 0; i < cantidadDescensos && totalPlayers - 1 - i >= 0; i++) {
                    ligaATableRows[totalPlayers - 1 - i].classList.add('relegation-zone');
                }
            }

            cantDescensosInput.addEventListener('input', () => {
                localStorage.setItem('cantidadDescensos', cantDescensosInput.value);
                updateRelegationZone();
            });

            updateRelegationZone();

            // === INICIO: L√ìGICA DE LA CINEM√ÅTICA ===
            const reiniciarForm = document.getElementById('reiniciar-form');
            const overlay = document.getElementById('cinematic-overlay');
            
            reiniciarForm.addEventListener('submit', function (event) {
                event.preventDefault(); // Detenemos el env√≠o del formulario

                if (!confirm('¬øEst√°s seguro de que quieres finalizar la temporada? Se aplicar√°n los cambios de divisi√≥n y se resetear√°n todas las estad√≠sticas.')) {
                    return; // Si el usuario cancela, no hacemos nada
                }

                // 1. Extraer los datos de las tablas
                const cantidadDescensos = parseInt(cantDescensosInput.value) || 0;

                // Campe√≥n
                const championName = document.querySelector('#ligaA-table tbody .player-name')?.textContent || 'No definido';
                
                // Ascendidos (SOLO el primero de la B) - L√çNEA CORREGIDA
                const promotedRows = Array.from(document.querySelectorAll('#ligaB-table tbody .player-row')).slice(0, 1);
                const promotedNames = promotedRows.map(row => row.querySelector('.player-name').textContent);

                // Descendidos (los √∫ltimos de la A)
                const allDivisionARows = Array.from(document.querySelectorAll('#ligaA-table tbody .player-row'));
                const relegatedRows = allDivisionARows.slice(-cantidadDescensos);
                const relegatedNames = relegatedRows.map(row => row.querySelector('.player-name').textContent);

                // Ocultar tarjetas si no hay datos
                document.getElementById('promoted-card').style.display = promotedNames.length > 0 ? 'block' : 'none';
                document.getElementById('relegated-card').style.display = relegatedNames.length > 0 ? 'block' : 'none';


                // 2. Poblar las tarjetas de la cinem√°tica
                const championList = document.getElementById('champion-list');
                const promotedList = document.getElementById('promoted-list');
                const relegatedList = document.getElementById('relegated-list');
                
                championList.innerHTML = `<li>${championName}</li>`;

                promotedList.innerHTML = ''; // Limpiar lista
                promotedNames.forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = name;
                    promotedList.appendChild(li);
                });

                relegatedList.innerHTML = ''; // Limpiar lista
                relegatedNames.forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = name;
                    relegatedList.appendChild(li);
                });


                // 3. Iniciar la secuencia de animaci√≥n
                overlay.classList.add('show');
                
                setTimeout(() => {
                    document.getElementById('champion-card').classList.add('visible');
                }, 500); // Aparece el campe√≥n despu√©s de 0.5s

                if (promotedNames.length > 0) {
                    setTimeout(() => {
                        document.getElementById('promoted-card').classList.add('visible');
                    }, 2500); // Aparecen los ascendidos despu√©s de 2.5s
                }
                
                if (relegatedNames.length > 0) {
                    setTimeout(() => {
                        document.getElementById('relegated-card').classList.add('visible');
                    }, 4500); // Aparecen los descendidos despu√©s de 4.5s
                }

                setTimeout(() => {
                    // Despu√©s de que toda la animaci√≥n ha terminado, enviamos el formulario
                    reiniciarForm.submit();
                }, 7000); // Enviamos el formulario despu√©s de 7s
            });
            // === FIN: L√ìGICA DE LA CINEM√ÅTICA ===
        });
    </script>
</body>
</html>